name: Security Pipeline (v0.1)
on: 
  workflow_call: 
jobs:
  secrets:
    name: Secrets scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Run Gitleaks (Docker)
        id: gitleaks
        shell: bash
        run: | 
          mkdir -p evidence
          set +e
          docker run --rm -v "${{ github.workspace }}:/repo" zricethezav/gitleaks:latest \
            detect --source="/repo" --redact --verbose --no-git \
            --report-format json --report-path /repo/evidence/gitleaks.json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          set -e
          exit 0
        
      - name: Upload evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-gitleaks
          path: evidence/
      
      - name: Fail if leaks were found
        if: steps.gitleaks.outputs.exit_code != '0'
        run: exit 1
    
      
