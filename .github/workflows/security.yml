name: Security Pipeline (v0.2)
on: 
  push:
  pull_request:
  workflow_call: 
jobs:
  secrets:
    name: Secrets scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Run Gitleaks (Docker)
        id: gitleaks
        shell: bash
        run: | 
          mkdir -p evidence
          set +e
          docker run --rm -v "${{ github.workspace }}:/repo" zricethezav/gitleaks:latest \
            detect --source="/repo" --redact --verbose --no-git \
            --report-format json --report-path /repo/evidence/gitleaks.json
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          set -e
          exit 0

      - name: Normalize evidence (gitleaks)
        if: always()
        shell: bash
        run: |
          python3 scripts/normalize_evidence.py gitleaks \
            evidence/gitleaks.json evidence/normalized/gitleaks.json
        
      - name: Upload evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-gitleaks
          path: evidence/
      
      - name: Fail if leaks were found
        if: steps.gitleaks.outputs.exit_code != '0'
        run: exit 1

  sast:
    name: SAST scan (semgrep)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Semgrep (Docker)
        id: semgrep
        shell: bash
        run: |
          mkdir -p evidence
          BASELINE_SHA="${{ github.event.pull_request.base.sha }}"
          BASELINE_ARG=""
          if [ -n "$BASELINE_SHA" ]; then
            BASELINE_ARG="--baseline-commit $BASELINE_SHA"
          fi
          set +e
          docker run --rm -v "${{ github.workspace }}:/repo" semgrep/semgrep:latest \
            semgrep --config p/ci --severity ERROR --error --json --output /repo/evidence/semgrep.json $BASELINE_ARG /repo
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          set -e
          exit 0

      - name: Normalize evidence (semgrep)
        if: always()
        shell: bash
        run: |
          python3 scripts/normalize_evidence.py semgrep \
            evidence/semgrep.json evidence/normalized/semgrep.json

      - name: Upload evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: evidence-semgrep
          path: evidence/

      - name: Fail if findings were found
        if: steps.semgrep.outputs.exit_code != '0'
        run: exit 1
    
  quality_gate:
    name: Quality gate (policy)
    runs-on: ubuntu-latest
    needs: [secrets, sast]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download evidence (gitleaks)
        uses: actions/download-artifact@v4
        with:
          name: evidence-gitleaks
          path: evidence/gitleaks

      - name: Download evidence (semgrep)
        uses: actions/download-artifact@v4
        with:
          name: evidence-semgrep
          path: evidence/semgrep

      - name: Evaluate policy
        shell: bash
        run: |
          python3 scripts/aggregate_evidence.py .security/policy.json
